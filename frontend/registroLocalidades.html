<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Localidades</title>
    <link rel="stylesheet" href="./css/panel_general.css">
    <link rel="stylesheet" href="./css/resgistroLocalidades.css">

</head>

<body>
    <header class="header">
        <h1>Gestión de Localidades</h1>
    </header>

    <main class="main-content">

        <!-- REGISTRO DE LOCALIDADES-->
        <section class="welcome-section">
            <h2>Registro de Localidades</h2>
            <form id="formRegistrarLocalidades" class="grid-container">

                <!-- Nombre del Centro de Trabajo -->
                <div class="form-field">
                    <label for="nombre_centro_trabajo">Nombre del Centro de Trabajo</label>
                    <input type="text" id="nombre_centro_trabajo" name="nombre_centro_trabajo" required maxlength="200"
                        pattern="^(?=.*[A-Za-zÀ-ÿÑñ])[A-Za-zÀ-ÿÑñ0-9\s\-\.,]+$" placeholder="Ej. PUBIS"
                        title="Solo letras y números">
                </div>




                <!-- Población -->
                <div class="form-field">
                    <label for="poblacion">Población</label>
                    <input type="text" id="poblacion" name="poblacion" required
                        pattern="^(?=.*[A-Za-zÀ-ÿÑñ])[A-Za-zÀ-ÿÑñ\s\-]+$" maxlength="100"
                        placeholder="Ej. San Luis Río Colorado">
                </div>

                <!-- Localidad -->
                <div class="form-field">
                    <label for="localidad">Localidad</label>
                    <input type="text" id="localidad" name="localidad" required maxlength="100"
                        pattern="^(?=.*[A-Za-zÀ-ÿÑñ])[A-Za-zÀ-ÿÑñ\s\-]+$" placeholder="Ej. Centro">
                </div>

                <!-- Estado -->
                <div class="form-field">
                    <label for="estado">Estado</label>
                    <select id="estado" name="estado" required>
                        <option value="">Seleccione un estado</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="tipo_instalacion">Tipo de Instalación</label>
                    <select id="tipo_instalacion" name="tipo_instalacion" required>
                        <option value="">Seleccione un Tipo de Instalación</option>
                        <option value="Centro Productivo">Centro Productivo</option>
                        <option value="Centro de Distribución">Centro de Distribución</option>
                        <option value="PODEBI">PODEBI</option>
                        <option value="Almacen">Almacen</option>

                    </select>
                </div>

                <!-- Ubicación Georeferenciada -->
                <div class="form-field">
                    <label for="ubicacion_georeferenciada">Ubicación Georeferenciada (Latitud, Longitud)</label>
                    <input type="text" id="ubicacion_georeferenciada" name="ubicacion_georeferenciada" required
                        maxlength="200" pattern="^-?\d{1,2}\.\d+,\s*-?\d{1,3}\.\d+$" placeholder="Ej. 19.4326, -99.1332"
                        title="Formato: latitud, longitud (Ej. 19.4326, -99.1332)">
                </div>
                <!-- Mapa para seleccionar ubicación -->
                <div id="map" style="height: 400px; margin-top: 20px;"></div>


                <div class="form-actions" style="grid-column: 1 / -1; justify-content: center;">
                    <button type="submit">Guardar</button>
                    <button type="button" id="btnCancelar">Cancelar</button>
                </div>


            </form>
            <div id="mensaje-registro"></div>

        </section>
    </main>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- cancelar.js -->
    <script src="../js/cancelar.js"></script>

    <!-- estados.js -->
    <script src="../js/estados.js"></script>

    <!-- estados.js -->
    <script src="../js/registrarLocalidad.js"></script>

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // Inicializar el mapa centrado en México
        const map = L.map('map').setView([23.6345, -102.5528], 5);

        // Capa base de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let marker;

        // Al hacer clic en el mapa
        map.on('click', async function (e) {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);

            // Mostrar o mover marcador
            if (marker) {
                marker.setLatLng(e.latlng);
            } else {
                marker = L.marker(e.latlng).addTo(map);
            }

            // Actualizar campo de coordenadas
            document.getElementById('ubicacion_georeferenciada').value = `${lat}, ${lng}`;

            // === Geocodificación inversa (obtener localidad/estado) ===
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`);
                const data = await response.json();

                if (data && data.address) {
                    const address = data.address;

                    // Extraer los datos más relevantes
                    const localidad = address.village || address.town || address.city || address.suburb || '';
                    const estado = address.state || '';

                    // Rellenar los campos del formulario si existen
                    if (localidad) document.getElementById('localidad').value = localidad;
                    if (estado) document.getElementById('estado').value = estado;
                }
            } catch (error) {
                console.error('Error al obtener los datos de ubicación:', error);
            }
        });
    </script>




</body>

</html>